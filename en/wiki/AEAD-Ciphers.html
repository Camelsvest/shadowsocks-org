<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Shadowsocks - AEAD Ciphers</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content=""><meta name="author" content=""><link rel="stylesheet" href="/assets/css/app.css"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico"><link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/apple-touch-icon-114x114.png"></head><body><div class="boxed" id="wrap"><header><div class="container clearfix"><div class="four columns"><div class="logo"><a href="/#{self.version}/index.html">shadowsocks</a></div></div><div class="twelve columns"><nav class="navigation" id="menu"><ul id="nav"><li><a class="#{active}" href="javascript:void">download</a><ul><li><a href="/en/download/clients.html">Clients</a></li><li><a href="/en/download/servers.html">Servers</a></li></ul></li><li><a class="#{active}" href="javascript:void">config</a><ul><li><a href="/en/config/quick-guide.html">Quick Guide</a></li><li><a href="/en/config/advanced.html">Advanced</a></li></ul></li><li><a class="#{active}" href="javascript:void">wiki</a><ul><li><a href="/en/wiki/AEAD-Ciphers.html">AEAD Ciphers</a></li><li><a href="/en/wiki/Implementations.html">Implementations</a></li><li><a href="/en/wiki/Plugin.html">Plugin</a></li><li><a href="/en/wiki/Protocol.html">Protocol</a></li><li><a href="/en/wiki/SIP002-URI-Scheme.html">SIP002 URI Scheme</a></li><li><a href="/en/wiki/SIP008-Online-Configuration-Delivery.html">SIP008 Online Configuration Delivery</a></li><li><a href="/en/wiki/Setup-fail2ban.html">Setup Fail2ban</a></li><li><a href="/en/wiki/Stream-Ciphers.html">Stream Ciphers</a></li></ul></li><li><a class="#{active}" href="javascript:void">about</a><ul><li><a href="/en/about/contributors.html">Contributors</a></li></ul></li><li><a href="javascript:void">en</a><ul><li><a href="/en/index.html">en</a></li></ul></li></ul></nav></div><div class="sixteen columns"><hr></div></div></header><div class="container clearfix"><div class="sixteen columns"><h1 class="page-title">AEAD Ciphers<a class="edit" href="#{self.editUrl}" data-tooltip="Edit this page on GitHub"><i class="icon-edit"></i></a><span class="line"></span></h1></div><div class="page-columns"><div class="sixteen columns bottom" id="markdown"><p><a href="https://en.wikipedia.org/wiki/Authenticated_encryption">AEAD</a> stands for Authenticated Encryption with Associated Data. AEAD ciphers simultaneously provide confidentiality, integrity, and authenticity. They have excellent performance and power efficiency on modern hardware. Users should use AEAD ciphers whenever possible.</p><p>The following AEAD ciphers are recommended. Compliant Shadowsocks implementations must support AEAD_CHACHA20_POLY1305. Implementations for devices with hardware AES acceleration should also implement AEAD_AES_128_GCM and AEAD_AES_256_GCM.</p><table><tr><th>Name</th><th>Alias</th><th>Key Size</th><th>Salt Size</th><th>Nonce Size</th><th>Tag Size</th></tr><tr><td>AEAD_CHACHA20_POLY1305</td><td>chacha20-ietf-poly1305</td><td>32</td><td>32</td><td>12</td><td>16</td></tr><tr><td>AEAD_AES_256_GCM</td><td>aes-256-gcm</td><td>32</td><td>32</td><td>12</td><td>16</td></tr><tr><td>AEAD_AES_128_GCM</td><td>aes-128-gcm</td><td>16</td><td>16</td><td>12</td><td>16</td></tr></table><p>Please refer to <a href="https://www.iana.org/assignments/aead-parameters/aead-parameters.xhtml">IANA AEAD registry</a> for naming scheme and specification.</p><p>The way Shadowsocks using AEAD ciphers is specified in <a href="https://github.com/shadowsocks/shadowsocks-org/issues/30">SIP004</a> and amended in <a href="https://github.com/shadowsocks/shadowsocks-org/issues/42">SIP007</a>. <a href="https://github.com/shadowsocks/shadowsocks-org/issues/30">SIP004</a> was proposed by <a href="https://github.com/Mygod">@Mygod</a> with design inspirations from <a href="https://github.com/wongsyrone">@wongsyrone</a>, <a href="https://github.com/noisyfox">@Noisyfox</a> and <a href="https://github.com/breakwa11">@breakwa11</a>. <a href="https://github.com/shadowsocks/shadowsocks-org/issues/42">SIP007</a> was proposed by <a href="https://github.com/riobard">@riobard</a> with input from <a href="https://github.com/madeye">@madeye</a>, <a href="https://github.com/Mygod">@Mygod</a>, <a href="https://github.com/wongsyrone">@wongsyrone</a>, and many others.</p><h2>Key Derivation</h2><p>The master key can be input directly from user or generated from a password. The key derivation is still following EVP_BytesToKey(3) in OpenSSL. The detailed spec can be found here: <a href="https://wiki.openssl.org/index.php/Manual:EVP_BytesToKey(3">https://wiki.openssl.org/index.php/Manual:EVP_BytesToKey(3</a>)</p><p><a href="https://tools.ietf.org/html/rfc5869">HKDF_SHA1</a> is a function that takes a secret key, a non-secret salt, an info string, and produces a subkey that is cryptographically strong even if the input secret key is weak.</p><pre><code><span class="hljs-constructor">HKDF_SHA1(<span class="hljs-params">key</span>, <span class="hljs-params">salt</span>, <span class="hljs-params">info</span>)</span> =&gt; subkey</code></pre><p>The info string binds the generated subkey to a specific application context. In our case, it must be the string &quot;ss-subkey&quot; without quotes.</p><p>We derive a per-session subkey from a pre-shared master key using HKDF_SHA1. Salt must be unique through the entire life of the pre-shared master key.</p><h2>Authenticated Encryption/Decryption</h2><p>AE_encrypt is a function that takes a secret key, a non-secret nonce, a message, and produces ciphertext and authentication tag. Nonce must be unique for a given key in each invocation.</p><pre><code><span class="hljs-constructor">AE_encrypt(<span class="hljs-params">key</span>, <span class="hljs-params">nonce</span>, <span class="hljs-params">message</span>)</span> =&gt; (ciphertext, tag)</code></pre><p>AE_decrypt is a function that takes a secret key, non-secret nonce, ciphertext, authentication tag, and produces original message. If any of the input is tampered with, decryption will fail.</p><pre><code><span class="hljs-constructor">AE_decrypt(<span class="hljs-params">key</span>, <span class="hljs-params">nonce</span>, <span class="hljs-params">ciphertext</span>, <span class="hljs-params">tag</span>)</span> =&gt; message</code></pre><h2>TCP</h2><p>An AEAD encrypted TCP stream starts with a randomly generated salt to derive the per-session subkey, followed by any number of encrypted chunks. Each chunk has the following structure:</p><pre><code>[<span class="hljs-keyword">encrypted</span> payload length][length tag][<span class="hljs-keyword">encrypted</span> payload][payload tag]</code></pre><p>Payload length is a 2-byte big-endian unsigned integer capped at 0x3FFF. The higher two bits are reserved and must be set to zero. Payload is therefore limited to 16*1024 - 1 bytes.</p><p>The first AEAD encrypt/decrypt operation uses a counting nonce starting from 0. After each encrypt/decrypt operation, the nonce is incremented by one as if it were an unsigned little-endian integer. Note that each TCP chunk involves two AEAD encrypt/decrypt operation: one for the payload length, and one for the payload. Therefore each chunk increases the nonce twice.</p><h2>UDP</h2><p>An AEAD encrypted UDP packet has the following structure</p><pre><code>[salt][<span class="hljs-keyword">encrypted</span> payload][tag]</code></pre><p>The salt is used to derive the per-session subkey and must be generated randomly to ensure uniqueness. Each UDP packet is encrypted/decrypted independently, using the derived subkey and a nonce with all zero bytes.</p></div></div></div><div class="push"></div></div><footer><div class="container"><div class="sisteen columns"><span class="copyright"><a href="https://github.com/shadowsocks">Projects of Shadowsocks</a>&nbsp;are distributed under different licenses, including &nbsp;<a href="https://github.com/shadowsocks/shadowsocks/blob/master/LICENSE">APL 2.0,</a>&nbsp;<a href="https://github.com/shadowsocks/shadowsocks-libev/blob/master/LICENSE">GPLv3</a>&nbsp; and &nbsp;<a href="https://github.com/shadowsocks/libQtShadowsocks/blob/master/LICENSE">LGPLv3</a>. Theme by <a href="http://karma-runner.github.io">Karma</a>.</span></div></div></footer></body><script src="/assets/js/app.js"></script><script src="/assets/js/analytics.js"></script></html>