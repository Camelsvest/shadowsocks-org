<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Shadowsocks - Advanced</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content=""><meta name="author" content=""><link rel="stylesheet" href="/assets/css/app.css"><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico"><link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/apple-touch-icon-114x114.png"></head><body><div class="boxed" id="wrap"><header><div class="container clearfix"><div class="four columns"><div class="logo"><a href="/#{self.version}/index.html">shadowsocks</a></div></div><div class="twelve columns"><nav class="navigation" id="menu"><ul id="nav"><li><a class="#{active}" href="javascript:void">download</a><ul><li><a href="/en/download/clients.html">Clients</a></li><li><a href="/en/download/servers.html">Servers</a></li></ul></li><li><a class="#{active}" href="javascript:void">config</a><ul><li><a href="/en/config/quick-guide.html">Quick Guide</a></li><li><a href="/en/config/advanced.html">Advanced</a></li></ul></li><li><a class="#{active}" href="javascript:void">wiki</a><ul><li><a href="/en/wiki/AEAD-Ciphers.html">AEAD Ciphers</a></li><li><a href="/en/wiki/Implementations.html">Implementations</a></li><li><a href="/en/wiki/Plugin.html">Plugin</a></li><li><a href="/en/wiki/Protocol.html">Protocol</a></li><li><a href="/en/wiki/SIP002-URI-Scheme.html">SIP002 URI Scheme</a></li><li><a href="/en/wiki/SIP008-Online-Configuration-Delivery.html">SIP008 Online Configuration Delivery</a></li><li><a href="/en/wiki/Setup-fail2ban.html">Setup Fail2ban</a></li><li><a href="/en/wiki/Stream-Ciphers.html">Stream Ciphers</a></li></ul></li><li><a class="#{active}" href="javascript:void">about</a><ul><li><a href="/en/about/contributors.html">Contributors</a></li></ul></li><li><a href="javascript:void">en</a><ul><li><a href="/en/index.html">en</a></li></ul></li></ul></nav></div><div class="sixteen columns"><hr></div></div></header><div class="container clearfix"><div class="sixteen columns"><h1 class="page-title">Advanced<a class="edit" href="#{self.editUrl}" data-tooltip="Edit this page on GitHub"><i class="icon-edit"></i></a><span class="line"></span></h1></div><div class="page-columns"><div class="sixteen columns bottom" id="markdown"><h2>Optimize the shadowsocks server on Linux</h2><p>First of all, upgrade your Linux kernel to 3.5 or later.</p><h3>Step 1, increase the maximum number of open file descriptors</h3><p>To handle thousands of concurrent TCP connections, we should increase the limit of file descriptors opened.</p><p>Edit the <code>limits.conf</code></p><pre><code class="language-bash">vi /etc/security/limits.conf</code></pre><p>Add these two lines</p><pre><code><span class="hljs-bullet">*</span> soft nofile 51200
<span class="hljs-bullet">*</span> hard nofile 51200

<span class="hljs-section"># for server running in root:</span>
root soft nofile 51200
root hard nofile 51200</code></pre><p>Then, before you start the shadowsocks server, set the ulimit first</p><pre><code class="language-bash"><span class="hljs-built_in">ulimit</span> -n 51200</code></pre><h3>Step 2, Tune the kernel parameters</h3><p>The priciples of tuning parameters for shadowsocks are</p><ol><li>Reuse ports and conections as soon as possible.</li><li>Enlarge the queues and buffers as large as possible.</li><li>Choose the TCP congestion algorithm for large latency and high throughput.</li></ol><p>Here is an example <code>/etc/sysctl.conf</code> of our production servers:</p><pre><code><span class="hljs-attribute">fs</span>.file-max = <span class="hljs-number">51200</span>

<span class="hljs-attribute">net</span>.core.rmem_max = <span class="hljs-number">67108864</span>
<span class="hljs-attribute">net</span>.core.wmem_max = <span class="hljs-number">67108864</span>
<span class="hljs-attribute">net</span>.core.netdev_max_backlog = <span class="hljs-number">250000</span>
<span class="hljs-attribute">net</span>.core.somaxconn = <span class="hljs-number">4096</span>

<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_syncookies = <span class="hljs-number">1</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_tw_reuse = <span class="hljs-number">1</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_tw_recycle = <span class="hljs-number">0</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_fin_timeout = <span class="hljs-number">30</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_keepalive_time = <span class="hljs-number">1200</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.ip_local_port_range = <span class="hljs-number">10000</span> <span class="hljs-number">65000</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_max_syn_backlog = <span class="hljs-number">8192</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_max_tw_buckets = <span class="hljs-number">5000</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_fastopen = <span class="hljs-number">3</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_mem = <span class="hljs-number">25600</span> <span class="hljs-number">51200</span> <span class="hljs-number">102400</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_rmem = <span class="hljs-number">4096</span> <span class="hljs-number">87380</span> <span class="hljs-number">67108864</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_wmem = <span class="hljs-number">4096</span> <span class="hljs-number">65536</span> <span class="hljs-number">67108864</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_mtu_probing = <span class="hljs-number">1</span>
<span class="hljs-attribute">net</span>.ipv<span class="hljs-number">4</span>.tcp_congestion_control = hybla</code></pre><p>Of course, remember to execute <code>sysctl -p</code> to reload the config at runtime.</p><h3>How to verify your optimizations work</h3><p>Use munin or any server monitor tools to generate the graph of your TCP connections. A well tuned server should look like this</p><p><img src="/assets/img/one_month_munin_tcp_graph.jpg" alt="one month munin TCP graph" width="" height=""></p></div></div></div><div class="push"></div></div><footer><div class="container"><div class="sisteen columns"><span class="copyright"><a href="https://github.com/shadowsocks">Projects of Shadowsocks</a>&nbsp;are distributed under different licenses, including &nbsp;<a href="https://github.com/shadowsocks/shadowsocks/blob/master/LICENSE">APL 2.0,</a>&nbsp;<a href="https://github.com/shadowsocks/shadowsocks-libev/blob/master/LICENSE">GPLv3</a>&nbsp; and &nbsp;<a href="https://github.com/shadowsocks/libQtShadowsocks/blob/master/LICENSE">LGPLv3</a>. Theme by <a href="http://karma-runner.github.io">Karma</a>.</span></div></div></footer></body><script src="/assets/js/app.js"></script><script src="/assets/js/analytics.js"></script></html>